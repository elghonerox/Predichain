name: Enterprise Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  FOUNDRY_PROFILE: 'ci'

jobs:
  # ============================================================================
  # JOB 1: Smart Contract Tests
  # ============================================================================
  smart-contracts:
    runs-on: ubuntu-latest
    env:
  PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
  BSC_TESTNET_RPC: ${{ secrets.BSC_TESTNET_RPC }}
  BSCSCAN_API_KEY: ${{ UG5FKCRDHIA674FU9QTVV3P9W6STCH1UUK }}
  
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better error reporting
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.cache/hardhat
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
        
    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: Run Solidity linter
      run: npx solhint 'contracts/**/*.sol' --max-warnings 0
      continue-on-error: false
      
    - name: Check Solidity formatting
      run: npx prettier --check 'contracts/**/*.sol'
      continue-on-error: false
      
    - name: Compile contracts
      run: npx hardhat compile
      env:
        HARDHAT_NETWORK: hardhat
        
    - name: Check compilation artifacts
      run: |
        if [ ! -d "artifacts/contracts" ]; then
          echo "‚ùå Contract compilation failed - no artifacts"
          exit 1
        fi
        echo "‚úÖ Compilation successful"
        
    - name: Run smart contract tests
      run: npx hardhat test --network hardhat
      env:
        REPORT_GAS: false
        HARDHAT_NETWORK: hardhat
        
    - name: Generate coverage report
      run: npx hardhat coverage --network hardhat
      continue-on-error: true
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage/lcov.info
        flags: smart-contracts
        name: smart-contracts-coverage
        fail_ci_if_error: false
        
    - name: Run gas reporter
      run: REPORT_GAS=true npx hardhat test --network hardhat
      continue-on-error: true
      
    - name: Save contract artifacts
      uses: actions/upload-artifact@v4
      with:
        name: contract-artifacts
        path: |
          artifacts/contracts/**/*.json
          deployments/*.json
        retention-days: 7
        
    - name: Save test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-contracts
        path: |
          coverage/
          gas-report.txt
        retention-days: 7

  # ============================================================================
  # JOB 2: Deploy to Test Network
  # ============================================================================
  deploy-testnet:
    runs-on: ubuntu-latest
    needs: smart-contracts
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: Download contract artifacts
      uses: actions/download-artifact@v4
      with:
        name: contract-artifacts
        path: artifacts
        
    - name: Deploy to Hardhat Network (Local Test)
      run: |
        # Start local node in background
        npx hardhat node &
        NODE_PID=$!
        sleep 10
        
        # Deploy contracts
        npx hardhat run scripts/deploy.js --network localhost
        
        # Kill node
        kill $NODE_PID
      env:
        HARDHAT_NETWORK: localhost
        
    - name: Verify deployment
      run: |
        if [ -f "deployments/localhost-latest.json" ]; then
          echo "‚úÖ Deployment successful"
          cat deployments/localhost-latest.json
        else
          echo "‚ùå Deployment failed"
          exit 1
        fi
        
    - name: Save deployment info
      uses: actions/upload-artifact@v4
      with:
        name: deployment-info
        path: deployments/*.json
        retention-days: 7

  # ============================================================================
  # JOB 3: Frontend Tests
  # ============================================================================
  frontend:
    runs-on: ubuntu-latest
    needs: deploy-testnet
    timeout-minutes: 15
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          frontend/node_modules
          frontend/.next/cache
        key: ${{ runner.os }}-frontend-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-
        
    - name: Download deployment info
      uses: actions/download-artifact@v4
      with:
        name: deployment-info
        path: deployments
        
    - name: Extract contract addresses
      run: |
        DEPLOYMENT_FILE="../deployments/localhost-latest.json"
        
        if [ -f "$DEPLOYMENT_FILE" ]; then
          PREDICTION_MARKET_ADDRESS=$(jq -r '.contracts.PredictionMarket.address' "$DEPLOYMENT_FILE")
          echo "NEXT_PUBLIC_PREDICTION_MARKET_ADDRESS=$PREDICTION_MARKET_ADDRESS" >> $GITHUB_ENV
          echo "‚úÖ Contract address: $PREDICTION_MARKET_ADDRESS"
        else
          echo "‚ö†Ô∏è  Using mock address for tests"
          echo "NEXT_PUBLIC_PREDICTION_MARKET_ADDRESS=0x0000000000000000000000000000000000000000" >> $GITHUB_ENV
        fi
        
    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: Type check
      run: npx tsc --noEmit
      continue-on-error: true
      
    - name: Lint check
      run: npm run lint
      continue-on-error: true
      
    - name: Build frontend
      run: npm run build
      env:
        NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID: ${{ secrets.WALLET_CONNECT_PROJECT_ID || '0893b6579e0a17ca509b1e6e231e8240' }}
        NEXT_PUBLIC_PREDICTION_MARKET_ADDRESS: ${{ env.NEXT_PUBLIC_PREDICTION_MARKET_ADDRESS }}
        NEXT_PUBLIC_CHAIN_ID: 31337
        NEXT_PUBLIC_RPC_URL: http://localhost:8545
        
    - name: Check build output
      run: |
        if [ -d ".next" ]; then
          echo "‚úÖ Build successful"
          du -sh .next
        else
          echo "‚ùå Build failed"
          exit 1
        fi
        
    - name: Save build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/.next
        retention-days: 7

  # ============================================================================
  # JOB 4: Integration Tests
  # ============================================================================
  integration:
    runs-on: ubuntu-latest
    needs: [smart-contracts, frontend]
    timeout-minutes: 20
    
    services:
      hardhat-node:
        image: node:18
        options: >-
          --health-cmd "curl -f http://localhost:8545 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        cd frontend && npm ci --prefer-offline --no-audit
        
    - name: Start local blockchain
      run: |
        npx hardhat node &
        NODE_PID=$!
        echo "NODE_PID=$NODE_PID" >> $GITHUB_ENV
        sleep 10
        
    - name: Deploy contracts to local network
      run: npx hardhat run scripts/deploy.js --network localhost
      
    - name: Run integration tests
      run: |
        # Add integration tests here when ready
        echo "‚úÖ Integration tests placeholder"
        
    - name: Cleanup
      if: always()
      run: |
        if [ ! -z "$NODE_PID" ]; then
          kill $NODE_PID || true
        fi

  # ============================================================================
  # JOB 5: Security Audit
  # ============================================================================
  security:
    runs-on: ubuntu-latest
    needs: smart-contracts
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: Run Slither security analysis
      uses: crytic/slither-action@v0.3.0
      continue-on-error: true
      with:
        target: 'contracts/'
        slither-args: '--filter-paths "node_modules|test"'
        fail-on: high
        
    - name: Run npm audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

  # ============================================================================
  # JOB 6: Summary Report
  # ============================================================================
  summary:
    runs-on: ubuntu-latest
    needs: [smart-contracts, deploy-testnet, frontend, integration, security]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "# üìä Test Suite Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ‚úÖ Completed Jobs" >> $GITHUB_STEP_SUMMARY
        echo "- Smart Contracts: ${{ needs.smart-contracts.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deployment: ${{ needs.deploy-testnet.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend: ${{ needs.frontend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Integration: ${{ needs.integration.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
        
    - name: Check overall status
      if: |
        needs.smart-contracts.result != 'success' ||
        needs.deploy-testnet.result != 'success' ||
        needs.frontend.result != 'success'
      run: |
        echo "‚ùå One or more critical jobs failed"
        exit 1
